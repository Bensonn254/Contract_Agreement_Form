<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Website Development Agreement - Benard Odhiambo</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Work+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1a5490;
            --primary-dark: #0d3a6b;
            --accent: #f39c12;
            --text-dark: #2c3e50;
            --text-light: #7f8c8d;
            --bg-light: #f8f9fa;
            --border: #dee2e6;
            --success: #27ae60;
            --error: #e74c3c;
            --warning: #f39c12;
        }

        body {
            font-family: 'Work Sans', sans-serif;
            line-height: 1.6;
            color: var(--text-dark);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem 1rem;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 3rem 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse 15s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.1) rotate(5deg); }
        }

        .header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1rem;
            opacity: 0.95;
            position: relative;
            z-index: 1;
        }

        .step-indicator {
            background: white;
            padding: 1.5rem 2rem;
            border-bottom: 3px solid var(--primary);
        }

        .steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 600px;
            margin: 0 auto;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--border);
            color: var(--text-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .step.active .step-number {
            background: var(--primary);
            color: white;
        }

        .step.complete .step-number {
            background: var(--success);
            color: white;
        }

        .step-text {
            font-weight: 500;
            color: var(--text-light);
        }

        .step.active .step-text {
            color: var(--primary);
            font-weight: 600;
        }

        .step-divider {
            flex: 1;
            height: 2px;
            background: var(--border);
            margin: 0 1rem;
        }

        .form-content {
            padding: 3rem 2rem;
        }

        .section {
            margin-bottom: 2.5rem;
            padding: 2rem;
            background: var(--bg-light);
            border-radius: 12px;
            border-left: 4px solid var(--primary);
        }

        .section-title {
            font-family: 'Playfair Display', serif;
            color: var(--primary);
            font-size: 1.5rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-number {
            background: var(--primary);
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-dark);
        }

        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        textarea {
            width: 100%;
            padding: 0.875rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-family: 'Work Sans', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 84, 144, 0.1);
        }

        .info-box {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: var(--text-dark);
        }

        .info-value {
            color: var(--text-light);
            text-align: right;
        }

        .feature-list, .bullet-list {
            list-style: none;
            padding-left: 0;
        }

        .feature-list li, .bullet-list li {
            padding: 0.75rem 0;
            padding-left: 1.5rem;
            position: relative;
        }

        .feature-list li::before {
            content: '‚úì';
            position: absolute;
            left: 0;
            color: var(--success);
            font-weight: bold;
        }

        .bullet-list li::before {
            content: '‚Ä¢';
            position: absolute;
            left: 0;
            color: var(--primary);
            font-weight: bold;
        }

        .checkbox-group {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1rem 0;
            border: 2px solid var(--border);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .checkbox-group:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(26, 84, 144, 0.1);
        }

        .checkbox-group input[type="radio"] {
            margin-right: 1rem;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-group label {
            cursor: pointer;
            margin-bottom: 0;
        }

        .signature-section {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            margin-top: 1.5rem;
        }

        .signature-pad {
            border: 2px dashed var(--border);
            border-radius: 8px;
            background: var(--bg-light);
            cursor: crosshair;
            touch-action: none;
            margin-top: 0.5rem;
        }

        .signature-controls {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-family: 'Work Sans', sans-serif;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary {
            background: var(--border);
            color: var(--text-dark);
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            font-size: 1.25rem;
            padding: 1rem 2rem;
            width: 100%;
            margin-top: 2rem;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(26, 84, 144, 0.3);
        }

        .btn-primary:disabled {
            background: var(--border);
            cursor: not-allowed;
            transform: none;
            opacity: 0.6;
        }

        .price-highlight {
            background: linear-gradient(135deg, var(--accent) 0%, #e67e22 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            margin: 1rem 0;
        }

        .price-highlight h3 {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            display: none;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffc107;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .developer-info {
            background: var(--primary);
            color: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .developer-info h4 {
            font-family: 'Playfair Display', serif;
            margin-bottom: 0.5rem;
        }

        .next-steps {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 1.5rem;
            border-radius: 8px;
            margin: 2rem 0;
        }

        .next-steps h4 {
            color: #856404;
            margin-bottom: 1rem;
            font-family: 'Playfair Display', serif;
        }

        .next-steps ol {
            padding-left: 1.5rem;
            color: #856404;
        }

        .next-steps li {
            margin-bottom: 0.5rem;
        }

        .developer-view {
            background: #e8f5e9;
            border: 3px solid var(--success);
            padding: 2rem;
            border-radius: 12px;
        }

        .developer-view h3 {
            color: var(--success);
            font-family: 'Playfair Display', serif;
            margin-bottom: 1rem;
        }

        .warning-box {
            background: #fff3cd;
            border: 3px solid var(--warning);
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
        }

        .warning-box h3 {
            color: #856404;
            font-family: 'Playfair Display', serif;
            margin-bottom: 1rem;
            font-size: 2rem;
        }

        .warning-box p {
            color: #856404;
            font-size: 1.1rem;
            margin: 1rem 0;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: white;
            margin-top: 1rem;
            font-size: 1.2rem;
            text-align: center;
        }

        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }

            .header h1 {
                font-size: 1.75rem;
            }

            .form-content {
                padding: 2rem 1.5rem;
            }

            .section {
                padding: 1.5rem;
            }

            .info-row {
                flex-direction: column;
            }

            .info-value {
                text-align: left;
                margin-top: 0.25rem;
            }

            .steps {
                flex-direction: column;
                gap: 1rem;
            }

            .step-divider {
                width: 2px;
                height: 30px;
                margin: 0.5rem 0;
            }
        }

        .timestamp {
            font-size: 0.875rem;
            color: var(--text-light);
            margin-top: 0.5rem;
            font-style: italic;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div style="text-align: center;">
            <div class="spinner"></div>
            <div class="loading-text" id="loadingText">Sending email to developer...</div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>Website Development Agreement</h1>
            <p>Professional Web Services by Benard Odhiambo</p>
        </div>

        <div class="step-indicator">
            <div class="steps">
                <div class="step active" id="step1Indicator">
                    <div class="step-number">1</div>
                    <div class="step-text">Client Signs</div>
                </div>
                <div class="step-divider"></div>
                <div class="step" id="step2Indicator">
                    <div class="step-number">2</div>
                    <div class="step-text">Developer Signs</div>
                </div>
            </div>
        </div>

        <div class="form-content">
            <!-- ALREADY SUBMITTED WARNING -->
            <div id="alreadySubmittedWarning" class="hidden">
                <div class="warning-box">
                    <h3>‚ö†Ô∏è Already Submitted</h3>
                    <p>You have already submitted this agreement!</p>
                    <p>Your signature was recorded on <strong id="submissionDate"></strong></p>
                    <p style="margin-top: 2rem;">If you need to make changes, please contact:</p>
                    <div style="background: white; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                        <p><strong>Benard Odhiambo</strong></p>
                        <p>Phone: +254 743 052 401</p>
                        <p>Email: odhiambobenard33@gmail.com</p>
                    </div>
                </div>
            </div>

            <!-- CLIENT VIEW -->
            <div id="clientView">
                <div class="next-steps">
                    <h4>üìã How This Works:</h4>
                    <ol>
                        <li><strong>You (Client)</strong> fill in your details and sign below</li>
                        <li>Click "Submit Client Signature"</li>
                        <li>An email is automatically sent to Benard (Developer)</li>
                        <li>You'll be redirected to a success page with your copy</li>
                        <li>Benard reviews and adds his signature</li>
                        <li>You both receive the final signed agreement</li>
                    </ol>
                </div>

                <form id="agreementForm">
                    <!-- Date -->
                    <div class="form-group">
                        <label for="agreementDate">Agreement Date *</label>
                        <input type="date" id="agreementDate" name="agreementDate" required>
                    </div>

                    <!-- Section 1: The Parties -->
                    <div class="section">
                        <h2 class="section-title">
                            <span class="section-number">1</span>
                            The Parties
                        </h2>
                        
                        <div class="developer-info">
                            <h4>Developer</h4>
                            <p><strong>Name:</strong> Benard Odhiambo</p>
                            <p><strong>Phone:</strong> +254 743 052 401</p>
                            <p><strong>Email:</strong> odhiambobenard33@gmail.com</p>
                        </div>

                        <div class="info-box">
                            <h4 style="margin-bottom: 1rem;">Client Information</h4>
                            <div class="form-group">
                                <label for="clientName">Business/Client Name *</label>
                                <input type="text" id="clientName" name="clientName" placeholder="e.g., Kyle's Pharmacy" required>
                            </div>
                            <div class="form-group">
                                <label for="clientPhone">Phone Number *</label>
                                <input type="tel" id="clientPhone" name="clientPhone" placeholder="+254 ..." required>
                            </div>
                            <div class="form-group">
                                <label for="clientEmail">Email Address *</label>
                                <input type="email" id="clientEmail" name="clientEmail" placeholder="email@example.com" required>
                            </div>
                        </div>
                    </div>

                    <!-- Section 2: Project Scope & Technical Specifications -->
                    <div class="section">
                        <h2 class="section-title">
                            <span class="section-number">2</span>
                            Project Scope & Technical Specifications
                        </h2>
                        <p>The Developer will design and develop a professional, mobile-responsive pharmacy website including:</p>
                        <ul class="feature-list">
                            <li><strong>Informational Pages:</strong> Home, About Us, Services, Contact, and Opening Hours</li>
                            <li><strong>WhatsApp Integration:</strong> Direct 'Click-to-Chat' button for patient inquiries</li>
                            <li><strong>Google Maps:</strong> Interactive map for easy navigation to the pharmacy location</li>
                            <li><strong>Contact Details:</strong> Clear display of phone numbers, physical address, and hours</li>
                            <li><strong>General Visibility:</strong> Optimized for basic search engine presence and local discovery</li>
                        </ul>

                        <p style="margin-top: 1.5rem; border-top: 1px solid var(--border); padding-top: 1.5rem;"><strong>Technical Boundaries (Standard Package):</strong></p>
                        <p style="font-size: 0.9rem; color: var(--text-light); margin-bottom: 0.5rem;">To maintain project efficiency and cost-effectiveness, the following advanced features are excluded from this agreement:</p>
                        <ul class="bullet-list" style="font-size: 0.9rem;">
                            <li>E-commerce functionality or online catalogs with checkout/payment processing</li>
                            <li>Inventory management systems or real-time stock tracking</li>
                            <li>Multi-user dashboards or staff login/account systems</li>
                            <li>Real-time syncing across multiple devices or pharmacy branches</li>
                            <li>AI-driven chatbots or automated customer support automation</li>
                            <li>Custom-built backend databases or deep data-driven applications</li>
                            <li>Integrations with third-party software not specifically named in this scope</li>
                        </ul>
                        <p style="margin-top: 1rem; font-size: 0.85rem; padding: 0.75rem; background: #fffbe6; border-radius: 6px;">
                            <em>* Any features outside this defined scope will be treated as Phase 2 and will require a separate agreement, timeline, and cost structure.</em>
                        </p>
                    </div>

                    <!-- Section 3: Investment & Payment -->
                    <div class="section">
                        <h2 class="section-title">
                            <span class="section-number">3</span>
                            Investment & Payment
                        </h2>
                        <div class="price-highlight">
                            <h3>Total Project Cost: KSh 7,500</h3>
                        </div>
                        <div class="info-box">
                            <div class="info-row">
                                <span class="info-label">Commitment Deposit (50%):</span>
                                <span class="info-value">KSh 3,500</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Final Balance (50%):</span>
                                <span class="info-value">KSh 4,000</span>
                            </div>
                        </div>
                    </div>

                    <!-- Section 4: Domain & Hosting -->
                    <div class="section">
                        <h2 class="section-title">
                            <span class="section-number">4</span>
                            Domain & Hosting (Choose One)
                        </h2>
                        <div class="checkbox-group">
                            <label>
                                <input type="radio" name="hostingOption" value="optionA" required>
                                <strong>Option A (Full Suite):</strong> KSh 3,500/year - Paid to provider for .co.ke domain + Premium Hosting
                            </label>
                        </div>
                        <div class="checkbox-group">
                            <label>
                                <input type="radio" name="hostingOption" value="optionB">
                                <strong>Option B (Lean):</strong> KSh 1,500/year - Client buys domain; Hosting is free via Netlify/Vercel
                            </label>
                        </div>
                    </div>

                    <!-- Section 5: Timeline & Revisions -->
                    <div class="section">
                        <h2 class="section-title">
                            <span class="section-number">5</span>
                            Timeline & Revisions
                        </h2>
                        <ul class="bullet-list">
                            <li><strong>Delivery:</strong> 3‚Äì5 days after deposit and content (logo, text, photos) are received</li>
                            <li><strong>Revisions:</strong> Includes 2 rounds of edits (text, images, minor layout tweaks)</li>
                        </ul>
                    </div>

                    <!-- Section 6: Maintenance -->
                    <div class="section">
                        <h2 class="section-title">
                            <span class="section-number">6</span>
                            Maintenance (Optional)
                        </h2>
                        <div class="checkbox-group">
                            <label>
                                <input type="radio" name="maintenance" value="yes">
                                <strong>Yes, I want maintenance:</strong> KSh 1,000/month for security updates, monthly backups, and minor content changes
                            </label>
                        </div>
                        <div class="checkbox-group">
                            <label>
                                <input type="radio" name="maintenance" value="no" checked>
                                <strong>No maintenance needed</strong>
                            </label>
                        </div>
                    </div>

                    <!-- Condensed sections 7-14 -->
                    <div class="section">
                        <h2 class="section-title">
                            <span class="section-number">7-14</span>
                            Additional Terms
                        </h2>
                        <p style="margin-bottom: 1rem;"><strong>This agreement includes:</strong></p>
                        <ul class="bullet-list">
                            <li><strong>Client Responsibilities:</strong> Provide content within 24 hours, feedback within 48 hours</li>
                            <li><strong>Project Scope:</strong> Defined in Section 2 (Includes: website, WhatsApp, maps; Excludes: e-commerce, custom databases, AI systems)</li>
                            <li><strong>Ownership:</strong> Client owns website upon full payment</li>
                            <li><strong>Payment Terms:</strong> Deposit non-refundable; Late fee KSh 500 after 7 days</li>
                            <li><strong>Post-Launch:</strong> 14-day warranty, training included</li>
                            <li><strong>Liability:</strong> Developer not liable for hosting downtime or third-party issues</li>
                            <li><strong>Termination:</strong> Either party may terminate with notice</li>
                            <li><strong>Disputes:</strong> Resolved through mediation per Kenyan law</li>
                        </ul>
                        <p style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-light);">
                            <em>Full terms viewable in the complete PDF after signing</em>
                        </p>
                    </div>

                    <!-- Client Signature -->
                    <div class="section">
                        <h2 class="section-title">
                            <span class="section-number">‚úçÔ∏è</span>
                            Your Signature (Client)
                        </h2>

                        <div class="signature-section">
                            <h4>Sign Below *</h4>
                            <canvas id="clientSignature" class="signature-pad" width="800" height="200"></canvas>
                            <div class="signature-controls">
                                <button type="button" class="btn btn-secondary" onclick="clearSignature('client')">Clear Signature</button>
                            </div>
                            <div class="timestamp" id="clientTimestamp"></div>
                        </div>
                    </div>

                    <div id="alertBox" class="alert"></div>

                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        Submit Client Signature & Send to Developer
                    </button>
                </form>
            </div>

            <!-- DEVELOPER VIEW -->
            <div id="developerView" class="hidden">
                <div class="developer-view">
                    <h3>üë®‚Äçüíª Developer Portal - Add Your Signature</h3>
                    <p>Review the client's information and add your signature to complete the agreement.</p>
                </div>

                <div id="clientInfoReview"></div>

                <div class="section">
                    <h2 class="section-title">
                        <span class="section-number">‚úçÔ∏è</span>
                        Developer Signature
                    </h2>

                    <div class="signature-section">
                        <h4>Sign Below *</h4>
                        <canvas id="developerSignature" class="signature-pad" width="800" height="200"></canvas>
                        <div class="signature-controls">
                            <button type="button" class="btn btn-secondary" onclick="clearSignature('developer')">Clear Signature</button>
                        </div>
                        <div class="timestamp" id="developerTimestamp"></div>
                    </div>
                </div>

                <div id="devAlertBox" class="alert"></div>

                <button type="button" class="btn btn-primary" id="finalizeBtn" onclick="finalizeBothSignatures()">
                    Complete Agreement & Download Final PDF
                </button>
            </div>
        </div>
    </div>

    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script type="module">
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // FIREBASE SETUP & CONFIGURATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Configuration provided by user
        const firebaseConfig = {
            apiKey: "AIzaSyBIq8QFM7y6cSAQDluJ-DlzQVdO2IMUNRg",
            authDomain: "agreementform-1f744.firebaseapp.com",
            databaseURL: "https://agreementform-1f744-default-rtdb.firebaseio.com",
            projectId: "agreementform-1f744",
            storageBucket: "agreementform-1f744.firebasestorage.app",
            messagingSenderId: "14564172954",
            appId: "1:14564172954:web:7abba2b3a1d77bbada2b23"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // EMAILJS CONFIGURATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const EMAILJS_CONFIG = {
            PUBLIC_KEY: "ZMa9U0M8DpXDm4lt1",      
            SERVICE_ID: "service_udtcj15",        
            TEMPLATE_ID: "template_2yqdcmk"       
        };

        // Initialize EmailJS
        (function(){
            emailjs.init(EMAILJS_CONFIG.PUBLIC_KEY);
        })();

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SIGNATURE PAD CLASS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        class SignaturePad {
            constructor(canvas) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.isDrawing = false;
                this.lastX = 0;
                this.lastY = 0;
                this.hasSigned = false;

                this.setupCanvas();
                window.addEventListener('resize', () => this.setupCanvas());

                this.canvas.addEventListener('mousedown', (e) => this.startDrawing(e));
                this.canvas.addEventListener('mousemove', (e) => this.draw(e));
                this.canvas.addEventListener('mouseup', () => this.stopDrawing());
                this.canvas.addEventListener('mouseout', () => this.stopDrawing());

                this.canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    this.startDrawing(touch);
                }, { passive: false });
                
                this.canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    this.draw(touch);
                }, { passive: false });
                
                this.canvas.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    this.stopDrawing();
                }, { passive: false });
            }

            setupCanvas() {
                const rect = this.canvas.getBoundingClientRect();
                this.canvas.style.width = rect.width + 'px';
                this.canvas.style.height = rect.height + 'px';
                
                const scale = window.devicePixelRatio || 1;
                this.canvas.width = rect.width * scale;
                this.canvas.height = rect.height * scale;
                
                this.ctx.scale(scale, scale);
                
                this.ctx.strokeStyle = '#2c3e50';
                this.ctx.lineWidth = 2.5;
                this.ctx.lineCap = 'round';
                this.ctx.lineJoin = 'round';
            }

            getCoordinates(e) {
                const rect = this.canvas.getBoundingClientRect();
                const clientX = e.clientX !== undefined ? e.clientX : e.touches?.[0]?.clientX;
                const clientY = e.clientY !== undefined ? e.clientY : e.touches?.[0]?.clientY;
                
                return {
                    x: clientX - rect.left,
                    y: clientY - rect.top
                };
            }

            startDrawing(e) {
                this.isDrawing = true;
                const coords = this.getCoordinates(e);
                this.lastX = coords.x;
                this.lastY = coords.y;
                
                this.ctx.beginPath();
                this.ctx.arc(coords.x, coords.y, 1, 0, Math.PI * 2);
                this.ctx.fill();
                this.hasSigned = true;
            }

            draw(e) {
                if (!this.isDrawing) return;
                
                this.hasSigned = true;
                const coords = this.getCoordinates(e);

                this.ctx.beginPath();
                this.ctx.moveTo(this.lastX, this.lastY);
                this.ctx.lineTo(coords.x, coords.y);
                this.ctx.stroke();

                this.lastX = coords.x;
                this.lastY = coords.y;
            }

            stopDrawing() {
                this.isDrawing = false;
            }

            clear() {
                const rect = this.canvas.getBoundingClientRect();
                this.ctx.clearRect(0, 0, rect.width, rect.height);
                this.hasSigned = false;
            }

            isEmpty() {
                return !this.hasSigned;
            }

            toDataURL() {
                return this.canvas.toDataURL();
            }

            loadSignature(dataURL) {
                const img = new Image();
                img.onload = () => {
                    const rect = this.canvas.getBoundingClientRect();
                    this.ctx.drawImage(img, 0, 0, rect.width, rect.height);
                    this.hasSigned = true;
                };
                img.src = dataURL;
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // MAIN APPLICATION LOGIC
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        let clientPad, developerPad;
        let storedFormData = null;
        let currentAgreementId = null;

        // Initialize based on URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const agreementIdFromUrl = urlParams.get('id');
        const isDeveloperView = urlParams.get('view') === 'developer';

        async function initApp() {
            if (isDeveloperView) {
                // DEVELOPER MODE
                document.getElementById('clientView').classList.add('hidden');
                document.getElementById('developerView').classList.remove('hidden');
                document.getElementById('step1Indicator').classList.add('complete');
                document.getElementById('step1Indicator').classList.remove('active');
                document.getElementById('step2Indicator').classList.add('active');
                
                developerPad = new SignaturePad(document.getElementById('developerSignature'));
                document.getElementById('developerSignature').addEventListener('mouseup', updateDeveloperTimestamp);
                document.getElementById('developerSignature').addEventListener('touchend', updateDeveloperTimestamp);
                
                // Fetch Data
                if (agreementIdFromUrl) {
                    currentAgreementId = agreementIdFromUrl;
                    showAlert('Loading agreement data from Firebase...', 'info', 'devAlertBox');
                    
                    try {
                        storedFormData = await fetchAgreementFromFirebase(currentAgreementId);
                        if (storedFormData) {
                            displayClientInfo(storedFormData);
                            showAlert('Client data loaded successfully.', 'success', 'devAlertBox');
                        } else {
                            showAlert('Agreement not found. Please check the link.', 'error', 'devAlertBox');
                        }
                    } catch (error) {
                        console.error("Firebase Error:", error);
                        showAlert('Error loading data: ' + error.message, 'error', 'devAlertBox');
                    }
                } else {
                    // Fallback to local storage (legacy support)
                    const local = localStorage.getItem('agreementData');
                    if (local) {
                        storedFormData = JSON.parse(local);
                        displayClientInfo(storedFormData);
                        showAlert('Loaded local test data. (Warning: This may not match what client signed if on different device)', 'warning', 'devAlertBox');
                    } else {
                        showAlert('No Agreement ID found in URL.', 'error', 'devAlertBox');
                    }
                }

            } else {
                // CLIENT MODE
                
                // NEW: Check if this is a client viewing a completed agreement (via email link)
                if (agreementIdFromUrl) {
                    try {
                        const data = await fetchAgreementFromFirebase(agreementIdFromUrl);
                        if (data && data.status === 'completed') {
                            // Show read-only view of the final agreement
                            document.getElementById('clientView').innerHTML = `
                                <div class="success-container" style="text-align: center; padding: 3rem;">
                                    <div style="background: #27ae60; color: white; width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; font-size: 2rem;">‚úì</div>
                                    <h1 style="color: #27ae60; font-family: 'Playfair Display', serif; margin-bottom: 1rem;">Agreement Completed</h1>
                                    <p style="font-size: 1.2rem; margin-bottom: 2rem;">This agreement has been signed by both parties.</p>
                                    
                                    <div style="background: #f8f9fa; padding: 2rem; border-radius: 12px; margin-bottom: 2rem; text-align: left;">
                                        <p><strong>Client:</strong> ${data.clientName}</p>
                                        <p><strong>Date:</strong> ${data.date}</p>
                                        <p><strong>Status:</strong> <span style="color: #27ae60; font-weight: bold;">Fully Signed</span></p>
                                    </div>

                                    <button onclick="generateFinalPDF(${JSON.stringify(data).replace(/"/g, '&quot;')})" class="btn btn-primary">
                                        Download Final PDF
                                    </button>
                                </div>
                            `;
                            return; // Stop further initialization
                        }
                    } catch (e) {
                         console.error("Error fetching for client view", e);
                    }
                }

                const hasSubmitted = localStorage.getItem('agreementSubmitted');
                const submissionDate = localStorage.getItem('submissionDate');
                if (hasSubmitted === 'true') {
                   document.getElementById('clientView').classList.add('hidden');
                   document.getElementById('alreadySubmittedWarning').classList.remove('hidden');
                   document.getElementById('submissionDate').textContent = submissionDate || 'Unknown date';
                }

                clientPad = new SignaturePad(document.getElementById('clientSignature'));
                
                // Set default date
                document.getElementById('agreementDate').valueAsDate = new Date();
                
                // Setup client pad listeners
                document.getElementById('clientSignature').addEventListener('mouseup', updateClientTimestamp);
                document.getElementById('clientSignature').addEventListener('touchend', updateClientTimestamp);
                
                // Form submission
                document.getElementById('agreementForm').addEventListener('submit', handleClientSubmit);
            }
        }

        // Start App
        initApp();

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // FIREBASE HELPER FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        async function saveAgreementToFirebase(id, data) {
            const agreementRef = ref(db, 'agreements/' + id);
            await set(agreementRef, data);
        }

        async function fetchAgreementFromFirebase(id) {
            const dbRef = ref(db);
            const snapshot = await get(child(dbRef, `agreements/${id}`));
            if (snapshot.exists()) {
                return snapshot.val();
            } else {
                return null;
            }
        }

        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // UI & LOGIC HELPERS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        window.clearSignature = function(type) {
            if (type === 'client' && clientPad) {
                clientPad.clear();
                document.getElementById('clientTimestamp').textContent = '';
            } else if (type === 'developer' && developerPad) {
                developerPad.clear();
                document.getElementById('developerTimestamp').textContent = '';
            }
        }

        function updateClientTimestamp() {
            if (!clientPad.isEmpty()) {
                const now = new Date();
                document.getElementById('clientTimestamp').textContent = 
                    `Signed on: ${now.toLocaleString('en-KE', { dateStyle: 'full', timeStyle: 'short' })}`;
            }
        }

        function updateDeveloperTimestamp() {
            if (!developerPad.isEmpty()) {
                const now = new Date();
                document.getElementById('developerTimestamp').textContent = 
                    `Signed on: ${now.toLocaleString('en-KE', { dateStyle: 'full', timeStyle: 'short' })}`;
            }
        }

        async function handleClientSubmit(e) {
            e.preventDefault();

            if (clientPad.isEmpty()) {
                showAlert('Please sign the agreement before submitting.', 'error');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';

            const uniqueId = generateUniqueId();
            
            const formData = {
                agreementId: uniqueId,
                date: document.getElementById('agreementDate').value,
                clientName: document.getElementById('clientName').value,
                clientPhone: document.getElementById('clientPhone').value,
                clientEmail: document.getElementById('clientEmail').value,
                hostingOption: document.querySelector('input[name="hostingOption"]:checked')?.value,
                maintenance: document.querySelector('input[name="maintenance"]:checked')?.value,
                clientSignature: clientPad.toDataURL(),
                clientTimestamp: document.getElementById('clientTimestamp').textContent,
                status: 'pending_developer_signature'
            };

            try {
                // 1. Save to Firebase
                await saveAgreementToFirebase(uniqueId, formData);

                // 2. Generate Client PDF
                // generateClientPDF(formData); // Disabled per user request - client waits for final copy

                // 3. Send Email to Developer
                await sendEmailToDeveloper(formData, uniqueId);

                // 4. Update UI
                localStorage.setItem('agreementSubmitted', 'true'); 
                setTimeout(() => {
                    window.location.href = 'success.html?client=' + encodeURIComponent(formData.clientName);
                }, 2000);

            } catch (error) {
                console.error("Submission Error:", error);
                showAlert('Error submitting agreement: ' + error.message, 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Client Signature & Send to Developer';
            }
        }

        async function sendEmailToDeveloper(data, agreementId) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.classList.add('active');

            // Construct URL with ID
            const devURL = `${window.location.origin}${window.location.pathname}?view=developer&id=${agreementId}`;

            const emailParams = {
                to_email: 'odhiambobenard33@gmail.com',
                client_name: data.clientName,
                client_email: data.clientEmail,
                client_phone: data.clientPhone,
                agreement_date: data.date,
                hosting_option: data.hostingOption === 'optionA' ? 'Option A (Full Suite - KSh 3,500/year)' : 'Option B (Lean - KSh 1,500/year)',
                maintenance: data.maintenance === 'yes' ? 'Yes (KSh 1,000/month)' : 'No',
                developer_link: devURL,
                subject: `New Agreement: ${data.clientName} - Ready for Your Signature`
            };

            try {
                await emailjs.send(EMAILJS_CONFIG.SERVICE_ID, EMAILJS_CONFIG.TEMPLATE_ID, emailParams);
                console.log('Email sent successfully!');
            } catch (error) {
                console.error('Email failed:', error);
            } finally {
                loadingOverlay.classList.remove('active');
            }
        }

        function displayClientInfo(data) {
            const html = `
                <div class="section">
                    <h2 class="section-title">
                        <span class="section-number">üìã</span>
                        Client Information
                    </h2>
                    <div class="info-box">
                        <div class="info-row">
                            <span class="info-label">Date:</span>
                            <span class="info-value">${data.date}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Client Name:</span>
                            <span class="info-value">${data.clientName}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Phone:</span>
                            <span class="info-value">${data.clientPhone}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Email:</span>
                            <span class="info-value">${data.clientEmail}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Hosting Option:</span>
                            <span class="info-value">${data.hostingOption === 'optionA' ? 'Option A (Full Suite)' : 'Option B (Lean)'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Maintenance:</span>
                            <span class="info-value">${data.maintenance === 'yes' ? 'Yes (KSh 1,000/month)' : 'No'}</span>
                        </div>
                    </div>
                    
                    <div class="signature-section" style="margin-top: 1rem;">
                        <h4>Client's Signature:</h4>
                        <canvas id="clientSigPreview" class="signature-pad" width="800" height="200"></canvas>
                        <div class="timestamp">${data.clientTimestamp}</div>
                    </div>
                </div>
            `;
            document.getElementById('clientInfoReview').innerHTML = html;
            
            const previewCanvas = document.getElementById('clientSigPreview');
            const previewCtx = previewCanvas.getContext('2d');
            const img = new Image();
            img.onload = () => {
                const rect = previewCanvas.getBoundingClientRect();
                const scale = window.devicePixelRatio || 1;
                previewCanvas.width = rect.width * scale;
                previewCanvas.height = rect.height * scale;
                previewCtx.scale(scale, scale);
                previewCtx.drawImage(img, 0, 0, rect.width, rect.height);
            };
            img.src = data.clientSignature;
        }

        async function sendFinalEmailToClient(data, agreementId) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            document.getElementById('loadingText').textContent = "Sending final copy to client...";
            loadingOverlay.classList.add('active');

            // Link for client to view the completed agreement
            const clientLink = `${window.location.origin}${window.location.pathname}?id=${agreementId}`;

            const emailParams = {
                to_email: data.clientEmail, // Send to Client this time!
                client_name: data.clientName,
                client_email: data.clientEmail,
                client_phone: data.clientPhone,
                agreement_date: data.date,
                hosting_option: data.hostingOption === 'optionA' ? 'Option A (Full Suite)' : 'Option B (Lean)',
                maintenance: data.maintenance === 'yes' ? 'Yes' : 'No',
                developer_link: clientLink, // Reusing this param to send the link
                subject: `AGREEMENT SIGNED: Website Development Agreement - ${data.clientName}`
            };

            try {
                await emailjs.send(EMAILJS_CONFIG.SERVICE_ID, EMAILJS_CONFIG.TEMPLATE_ID, emailParams);
                console.log('Final email sent to client!');
            } catch (error) {
                console.error('Final email failed:', error);
                showAlert('Could not send email to client (check console)', 'error', 'devAlertBox');
            } finally {
                loadingOverlay.classList.remove('active');
                document.getElementById('loadingText').textContent = "Sending email to developer..."; // Reset text
            }
        }

        window.finalizeBothSignatures = async function() {
            if (!storedFormData) {
                showAlert('No client data found. Please ask client to resubmit.', 'error', 'devAlertBox');
                return;
            }

            if (developerPad.isEmpty()) {
                showAlert('Please sign the agreement before finalizing.', 'error', 'devAlertBox');
                return;
            }

            const finalData = {
                ...storedFormData,
                developerSignature: developerPad.toDataURL(),
                developerTimestamp: document.getElementById('developerTimestamp').textContent,
                status: 'completed'
            };

            try {
                // Update Firebase with developer signature
                if (currentAgreementId) {
                    await saveAgreementToFirebase(currentAgreementId, finalData);
                }
                
                generateFinalPDF(finalData);
                
                // NEW: Send email to client
                await sendFinalEmailToClient(finalData, currentAgreementId);
                
                showAlert('Agreement completed! Final PDF downloaded and sent to client.', 'success', 'devAlertBox');
                
            } catch (error) {
                console.error("Finalize Error:", error);
                showAlert('Error saving final agreement: ' + error.message, 'error', 'devAlertBox');
            }
        }

        // Unified PDF Generator
        function generateStyledPDF(data, isFinal) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const width = doc.internal.pageSize.getWidth();
            const height = doc.internal.pageSize.getHeight();
            const margin = 15;
            let y = margin;
            
            // Usage helpers
            const primaryColor = [26, 84, 144]; 
            const grayColor = [100, 100, 100];

            // --- HEADER ---
            doc.setFillColor(...primaryColor);
            doc.rect(0, 0, width, 40, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont("times", "bold");
            doc.setFontSize(22);
            doc.text("WEBSITE DEVELOPMENT AGREEMENT", width/2, 20, { align: 'center' });
            
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text(`Date of Agreement: ${data.date}`, width/2, 30, { align: 'center' });
            
            y = 50;

            // --- PARTIES (Side by Side) ---
            doc.setDrawColor(200, 200, 200);
            doc.setLineWidth(0.1);
            
            // Developer
            doc.setFont("times", "bold");
            doc.setFontSize(12);
            doc.setTextColor(...primaryColor);
            doc.text("DEVELOPER", margin, y);
            
            doc.setFont("helvetica", "normal");
            doc.setFontSize(9);
            doc.setTextColor(0, 0, 0);
            doc.text("Benard Odhiambo", margin, y+6);
            doc.text("+254 743 052 401", margin, y+11);
            doc.text("odhiambobenard33@gmail.com", margin, y+16);
            
            // Client
            doc.setFont("times", "bold");
            doc.setFontSize(12);
            doc.setTextColor(...primaryColor);
            doc.text("CLIENT", width/2 + 10, y);
            
            doc.setFont("helvetica", "normal");
            doc.setFontSize(9);
            doc.setTextColor(0, 0, 0);
            doc.text(data.clientName || "", width/2 + 10, y+6);
            doc.text(data.clientPhone || "", width/2 + 10, y+11);
            doc.text(data.clientEmail || "", width/2 + 10, y+16);

            y += 25;

            // --- PROJECT DETAILS ---
            doc.setFillColor(245, 247, 250);
            doc.rect(margin, y, width - (margin*2), 25, 'F');
            doc.setFont("times", "bold");
            doc.setFontSize(11);
            doc.setTextColor(...primaryColor);
            doc.text("PROJECT SUMMARY", margin + 5, y + 8);
            
            doc.setFont("helvetica", "normal");
            doc.setFontSize(9);
            doc.setTextColor(0, 0, 0);
            const features = [
                "Professional Responsive Website (Home, About, Services, Contact)",
                "WhatsApp Integration & Google Maps",
                "Prescription Inquiry Feature"
            ];
            features.forEach((f, i) => {
                doc.text(`‚Ä¢ ${f}`, margin + 5, y + 14 + (i*5));
            });
            
            y += 35;

            // --- INVESTMENT ---
            doc.setDrawColor(...primaryColor);
            doc.setLineWidth(0.5);
            doc.rect(margin, y, width - (margin*2), 20);
            
            doc.setFont("times", "bold");
            doc.setFontSize(12);
            doc.text(`TOTAL PROJECT COST: KSh 7,500`, width/2, y + 8, { align: 'center' });
            
            doc.setFont("helvetica", "normal");
            doc.setFontSize(9);
            doc.text("Deposit: KSh 3,500  |  Balance: KSh 4,000", width/2, y + 15, { align: 'center' });
            
            y += 30;

            // --- SELECTIONS & TERMS ---
            doc.setFont("times", "bold");
            doc.setFontSize(11);
            doc.setTextColor(...primaryColor);
            doc.text("AGREEMENT TERMS & SELECTIONS", margin, y);
            y += 6;
            
            doc.setFont("helvetica", "normal");
            doc.setFontSize(9);
            doc.setTextColor(0, 0, 0);
            
            const hostingText = data.hostingOption === 'optionA' 
                ? 'Option A (Full Suite): KSh 3,500/year' 
                : 'Option B (Lean): KSh 1,500/year';
            const maintText = data.maintenance === 'yes' ? 'Yes (KSh 1,000/mo)' : 'No Maintenance';
            
            const terms = [
                `Selected Hosting: ${hostingText}`,
                `Maintenance Plan: ${maintText}`,
                "Timeline: Delivery 3-5 days after content receipt.",
                "Revisions: 2 rounds of minor edits included.",
                "Ownership: Client owns website upon full payment.",
                "Liability: Developer not liable for third-party hosting issues."
            ];
            
            terms.forEach(term => {
                doc.text(`‚Ä¢ ${term}`, margin, y);
                y += 5;
            });

            // --- SIGNATURES ---
            y = height - 50; 
            
            // Line
            doc.setDrawColor(200, 200, 200);
            doc.setLineWidth(0.5);
            doc.line(margin, y - 5, width - margin, y - 5);

            // Client Sig
            doc.setFont("times", "bold");
            doc.setTextColor(...primaryColor);
            doc.text("CLIENT SIGNATURE", margin, y);
            
            if (data.clientSignature) {
                try {
                    doc.addImage(data.clientSignature, 'PNG', margin, y + 2, 60, 25);
                    doc.setFontSize(7);
                    doc.setTextColor(...grayColor);
                    doc.text(data.clientTimestamp || "", margin, y + 30);
                } catch (e) {
                    doc.text("[Signature Error]", margin, y + 15);
                }
            }

            // Developer Sig
            doc.setFont("times", "bold");
            doc.setFontSize(11);
            doc.setTextColor(...primaryColor);
            doc.text("DEVELOPER SIGNATURE", width/2 + 10, y);
            
            if (isFinal && data.developerSignature) {
                 try {
                    doc.addImage(data.developerSignature, 'PNG', width/2 + 10, y + 2, 60, 25);
                    doc.setFontSize(7);
                    doc.setTextColor(...grayColor);
                    doc.text(data.developerTimestamp || "", width/2 + 10, y + 30);
                 } catch (e) {
                     console.error("Dev sig error", e);
                 }
            } else {
                doc.setFont("times", "italic");
                doc.setFontSize(10);
                doc.setTextColor(...grayColor);
                doc.text("[Pending Developer Signature]", width/2 + 10, y + 15);
            }

            // Footer
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.text("Generated via SmartContract - Benard Odhiambo", width/2, height - 5, { align: 'center' });

            // Save
            const suffix = isFinal ? "FINAL" : "ClientCopy";
            const filename = `Agreement_${suffix}_${(data.clientName || 'Client').replace(/[^a-z0-9]/gi, '_')}.pdf`;
            doc.save(filename);
        }

        function generateClientPDF(data) {
            generateStyledPDF(data, false);
        }

        function generateFinalPDF(data) {
            generateStyledPDF(data, true);
        }

        function showAlert(message, type, boxId = 'alertBox') {
            const alertBox = document.getElementById(boxId);
            alertBox.textContent = message;
            alertBox.className = `alert alert-${type}`;
            alertBox.style.display = 'block';
            
            if (type !== 'info') {
                setTimeout(() => {
                    alertBox.style.display = 'none';
                }, 5000);
            }
        }
    </script>
</body>
</html>
